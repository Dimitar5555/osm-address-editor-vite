var W=Object.defineProperty,X=Object.defineProperties;var Y=Object.getOwnPropertyDescriptors;var U=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,Q=Object.prototype.propertyIsEnumerable;var H=(t,e,s)=>e in t?W(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,M=(t,e)=>{for(var s in e||(e={}))Z.call(e,s)&&H(t,s,e[s]);if(U)for(var s of U(e))Q.call(e,s)&&H(t,s,e[s]);return t},J=(t,e)=>X(t,Y(e));import{j as P,r as n,d as v,o as ee,p as te,c as oe,b as se,m as re,M as ne,t as ae,a as ie,e as le,S as ce,L as de,N as pe,G as ue,F as z,f as ge,g as fe,h as he,i as me,R as ye,k as be}from"./vendor.a5335d74.js";const xe=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const f of r.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&i(f)}).observe(document,{childList:!0,subtree:!0});function s(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerpolicy&&(r.referrerPolicy=a.referrerpolicy),a.crossorigin==="use-credentials"?r.credentials="include":a.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(a){if(a.ep)return;a.ep=!0;const r=s(a);fetch(a.href,r)}};xe();const o=P.exports.jsx,d=P.exports.jsxs,j=P.exports.Fragment,B=()=>{const[t,e]=n.exports.useState(!1);n.exports.useEffect(()=>{e(v.exports.isLoggedIn())},[]);const s=n.exports.useCallback(()=>{(async()=>(await v.exports.login({mode:"popup",clientId:"q9sRK4UuNqv3_HLE8E7m2-wUAKS3XJSFWb9apehpAqE",scopes:["read_prefs","write_api","write_notes"],redirectUrl:window.location.href.replace(window.location.hash,"")}),e(v.exports.isLoggedIn()),window.location.reload()))()},[]),i=n.exports.useCallback(()=>{(async()=>(v.exports.logout(),e(!1)))()},[]);return o(j,{children:t?o("button",{style:{height:"44px"},className:"button py-1 px-1 border-transparent border-4 bg-gray-300 text-gray-900 hover:text-gray-500",onClick:i,children:"logout"}):o("button",{style:{height:"44px"},className:"button py-1 px-1 border-transparent border-4 bg-gray-300 text-gray-900 hover:text-gray-500",onClick:s,children:"login"})})},ve=()=>{const[t,e]=n.exports.useState(!1),[s,i]=n.exports.useState(void 0);return n.exports.useEffect(()=>{e(v.exports.isLoggedIn())},[]),n.exports.useEffect(()=>{!t||(async()=>{const a=await v.exports.getUser("me");i(a)})()},[t]),o(j,{children:s?o("img",{style:{width:"44px",height:"44px"},src:s.img.href,alt:s.display_name,title:s.display_name}):o("img",{})})},we=()=>{const[t,e]=n.exports.useState(!1),[s,i]=n.exports.useState(void 0);return n.exports.useEffect(()=>{e(v.exports.isLoggedIn())},[]),n.exports.useEffect(()=>{!t||(async()=>{const a=await v.exports.getUser("me");i(a)})()},[t]),d("div",{style:{zIndex:100,position:"relative",top:0,left:0,height:"44px",display:"flex",flexDirection:"row",backgroundColor:"rgba(0, 255, 255, 0.9)"},children:[d("div",{children:[o("h1",{className:"text-4xl font-bold",style:{display:"inline",margin:"0px"},children:"OSM address editor"}),s?d("span",{style:{marginLeft:"10px"},children:["Hi ",s==null?void 0:s.display_name,", You have"," ",s==null?void 0:s.changesets.count," changesets."]}):o("span",{style:{marginLeft:"10px"},children:"Please logged in as OSM user."})]}),d("div",{style:{display:"flex",flex:1,justifyContent:"end"},children:[o("div",{children:o(ve,{})}),o("div",{children:o(B,{})})]})]})},T={type:"FeatureCollection",features:[]},Se=()=>{const[t,e]=n.exports.useState(!1);return{fetchOverpass:n.exports.useCallback(async(i,a,r)=>{var I,L;if(console.log(r),r<16)return T;let f=300;if(r>17&&(f=200),r>18&&(f=100),r>19&&(f=50),t)return T;e(!0),console.log("overpass: loading...");let p="[out:json]";p+=`[timeout:25];
`,p+='way["building"]',p+=`(around:${f},${i},${a});
`,p+="out meta geom;",console.log(p);const y=await fetch(`https://lz4.overpass-api.de/api/interpreter?data=${encodeURIComponent(p)}`,{});if(y.status!==200)return e(!1),T;const b=await y.json();console.log("overpass json elements: ",b.elements);const x=ee(b);console.log("overpass osmtogeojson raw: ",x);for await(const g of x.features){if(!g.properties)continue;g.id=g.properties.id.split("/")[1];const S=(I=b.elements.filter(m=>g.id?typeof g.id=="number"?m.id===g.id:m.id===parseInt(g.id):!1))==null?void 0:I[0];if(S&&(g.properties.tags=S.tags,g.properties.nodes=S.nodes),g.geometry.type==="Polygon"){const m=te(g.geometry.coordinates);var C=oe(m);g.properties.center=C.geometry.coordinates}const w=g.properties.uid;if(w){let m=localStorage.getItem(w+"-icon");if(m===null){const k=await v.exports.getUser(w);((L=k.img)==null?void 0:L.href)?(m=k.img.href,localStorage.setItem(w+"-icon",k.img.href)):localStorage.setItem(w+"-icon","")}g.properties.userIconHref=m||""}}return console.log("overpass osmtogeojson converted: ",x),console.log("overpass: loaded."),e(!1),x},[]),loadingOverpass:t}},V=({feature:t})=>{var s;const e=JSON.parse((s=t.properties)==null?void 0:s.center);return d(j,{children:[d("span",{className:"longitude",children:["Longitude: ",Math.round(e[0]*1e4)/1e4]}),", ",d("span",{className:"latitude",children:["Latitude: ",Math.round(e[1]*1e4)/1e4," "]})]})},_={key:"addr:postcode",displayName:"\u90F5\u4FBF\u756A\u53F7",placeholder:"101-0021"},q=[{key:"addr:province",displayName:"\u90FD\u9053\u5E9C\u770C",placeholder:"\u6771\u4EAC\u90FD"},{key:"addr:city",displayName:"\u5E02\u533A\u753A\u6751",placeholder:"\u5343\u4EE3\u7530\u533A"},{key:"addr:quarter",displayName:"\u5730\u540D",placeholder:"\u5916\u795E\u7530"}],G=[{key:"addr:neighbourhood",displayName:"\u4E01\u76EE",placeholder:"1\u4E01\u76EE"},{key:"addr:block_number",displayName:"\u756A\u5730",placeholder:"17"},{key:"addr:housenumber",displayName:"\u53F7",placeholder:"6",prefix:"-"}];[_.key,...q.map(t=>t.key),...G.map(t=>t.key)];const $=({feature:t})=>{var e,s;return d(j,{children:[((e=t.properties)==null?void 0:e[_.key])&&o("span",{className:"addr:postcode",children:(s=t.properties)==null?void 0:s[_.key]})," ",q.map(i=>{var a,r;return((a=t.properties)==null?void 0:a[i.key])?o("span",{className:i.key,children:(r=t.properties)==null?void 0:r[i.key]},i.key):null})," ",G.map(i=>{var a,r,f;return((a=t.properties)==null?void 0:a[i.key])?d("span",{className:i.key,children:[(r=i.prefix)!=null?r:i.prefix,(f=t.properties)==null?void 0:f[i.key]]},i.key):null})]})},ke=()=>({detectCountry:n.exports.useCallback(async(e,s)=>{const a=await(await fetch("https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_0_countries.geojson")).json();for(const r of a.features)if(se([e,s],r.geometry))return console.log("country: ",r.properties),r},[])}),Ne={attribution:"https://yuiseki.github.io/osm-address-editor-vite/",host:"https://yuiseki.github.io/osm-address-editor-vite/",created_by:"osm-address-editor-vite",locale:navigator.language,comment:"Update address"},D=({feature:t,fieldName:e,label:s,placeholder:i})=>{var p;const[a,r]=n.exports.useState((p=t.properties)==null?void 0:p[e]);n.exports.useEffect(()=>{var y;r((y=t.properties)==null?void 0:y[e])},[t]);const f=n.exports.useCallback(y=>{r(y.currentTarget.value)},[]);return d("div",{className:"w-full md:w-1/6 py-1 px-2 mb-6 md:mb-0",children:[o("label",{className:"block tracking-wide text-gray-700 text-xs font-bold mb-2",htmlFor:e,children:s||e}),o("input",{className:"appearance-none block w-full leading-tight rounded py-2 px-1 border border-gray-300 bg-gray-100 text-black placeholder-gray-500 placeholder-opacity-50 focus:outline-none focus:bg-white focus:border-gray-500",id:e,name:e,type:"text",placeholder:i,value:a,onChange:f})]})},Ce=({feature:t,onCancel:e,onSubmit:s})=>{var S,w,m,k,R;const{detectCountry:i}=ke(),a=JSON.parse((S=t.properties)==null?void 0:S.center),[r,f]=n.exports.useState(void 0),[p,y]=n.exports.useState(t),[b,x]=n.exports.useState(!1),[C,I]=n.exports.useState(!1);n.exports.useEffect(()=>{I(v.exports.isLoggedIn())},[]),n.exports.useEffect(()=>{(async()=>{const u=await i(a[0],a[1]);f(u)})()},[t]),n.exports.useEffect(()=>{console.log(p.properties)},[p]);const L=n.exports.useCallback(async()=>{console.info("openReverseGeocoder",[a[0],a[1]]);const u=await re.openReverseGeocoder([a[0],a[1]]);console.info("openReverseGeocoder",u),y(N=>{const A={properties:M({"addr:province":u.prefecture,"addr:city":u.city},N.properties)};return M(M({},N),A)})},[]),g=n.exports.useCallback(async u=>{var h,E,O;x(!0),u.preventDefault();const N=new FormData(u.currentTarget),A=JSON.parse((h=t.properties)==null?void 0:h.tags);N.forEach((F,K)=>{typeof F=="string"&&F.length>0&&(A[K]=F)});const l={type:"way",id:t.id,version:(E=t.properties)==null?void 0:E.version,tags:A,nodes:JSON.parse((O=t.properties)==null?void 0:O.nodes)};console.info(JSON.stringify(l,null,2));const c={create:[],modify:[l],delete:[]};await v.exports.uploadChangeset(Ne,c),x(!1),window.alert(`Successfully updated OpenStreetMap!!!
 Wait a minutes to apply to the map...`),s()},[t]);return o("div",{children:p.properties&&d(j,{children:[d("div",{children:["OSM:"," ",o("a",{className:"underline text-blue-600 hover:text-blue-800 visited:text-purple-600",href:"https://www.openstreetmap.org/"+p.properties.id,target:"_blank",children:p.properties.id})," | ",o(V,{feature:p}),((w=r==null?void 0:r.properties)==null?void 0:w.ISO_A3)==="JPN"&&d("span",{children:[" | ","Address:"," ",o("span",{className:"underline",children:o($,{feature:p})})]})]}),((m=r==null?void 0:r.properties)==null?void 0:m.ISO_A3)==="JPN"?d("form",{onSubmit:g,children:[d("div",{className:"flex flex-wrap",children:[o(D,{feature:p,fieldName:_.key,label:_.displayName,placeholder:_.placeholder}),q.map(u=>o(D,{feature:p,fieldName:u.key,label:u.displayName,placeholder:u.placeholder},u.key))]}),o("div",{className:"flex flex-wrap",children:G.map(u=>o(D,{feature:p,fieldName:u.key,label:u.displayName,placeholder:u.placeholder},u.key))}),o("div",{className:"flex flex-wrap",children:d("div",{className:"w-full py-2 px-2 mb-6 md:mb-0",children:[o("button",{type:"button",onClick:e,className:"button rounded mr-4 py-2 px-3  bg-gray-200 text-red-600 hover:text-red-800",children:"Cancel"}),o("button",{type:"button",onClick:L,className:"button rounded mr-4 py-2 px-3 bg-green-300 text-gray-800 hover:text-white",children:"Load address from coordinates"}),o("button",{disabled:!C||b,className:"button rounded mr-2 py-2 px-3 bg-blue-300 text-gray-800 disabled:bg-blue-100 disabled:text-gray-400 hover:text-white",children:"Submit to OpenStreetMap!"}),!C&&d(j,{children:[o("span",{className:"mr-2 underline text-red-600",children:"Require logged in before you submit data to OpenStreetMap"}),o(B,{})]})]})})]}):o("div",{className:"flex flex-wrap",children:d("div",{className:"w-full mb-6 md:mb-0",children:[d("div",{className:"py-2",children:[d("p",{children:["Sorry, Address editor in this country"," ",(k=r==null?void 0:r.properties)==null?void 0:k.ABBREV," (ISO code:",(R=r==null?void 0:r.properties)==null?void 0:R.ISO_A3,") does not support yet."]}),o("p",{children:o("a",{href:"https://github.com/yuiseki/osm-address-editor-vite",target:"_blank",className:"underline text-blue-600 hover:text-blue-800 visited:text-purple-600",children:"Pull requests are welcome!"})})]}),o("button",{type:"button",onClick:e,className:"button rounded mr-4 py-2 px-3  bg-gray-200 text-red-600 hover:text-red-800",children:"Cancel"})]})})]})})};function Ie(t,e){const[s,i]=n.exports.useState(t);return n.exports.useEffect(()=>{const a=setTimeout(()=>{i(t)},e);return()=>{clearTimeout(a)}},[t,e]),s}const Ee={version:8,sources:{"raster-tiles":{type:"raster",tiles:["https://a.tile.openstreetmap.org/{z}/{x}/{y}.png","https://b.tile.openstreetmap.org/{z}/{x}/{y}.png","https://c.tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:"\xA9 OpenStreetMap contributors"}},layers:[{id:"osm-tiles",type:"raster",source:"raster-tiles",minzoom:0,maxzoom:20}]},Le={id:"buildings-layer-fill",type:"fill",source:"buildings-source",paint:{"fill-color":["case",["boolean",["feature-state","select"],!1],"green",["all",["boolean",["has","addr:postcode"],!1],["boolean",["has","addr:province"],!1],["boolean",["has","addr:city"],!1],["boolean",["has","addr:quarter"],!1],["boolean",["has","addr:neighbourhood"],!1],["boolean",["has","addr:block_number"],!1],["boolean",["has","addr:housenumber"],!1]],"blue",["any",["boolean",["has","addr:postcode"],!1],["boolean",["has","addr:province"],!1],["boolean",["has","addr:city"],!1],["boolean",["has","addr:quarter"],!1],["boolean",["has","addr:neighbourhood"],!1],["boolean",["has","addr:block_number"],!1],["boolean",["has","addr:housenumber"],!1]],"yellow","red"],"fill-opacity":["case",["boolean",["feature-state","select"],!1],.8,["boolean",["feature-state","hover"],!1],.8,.4]},filter:["==","$type","Polygon"]};function Ae(){const t=n.exports.useRef(null),[e,s]=n.exports.useState(),i=Ie(e,1e3),a=n.exports.useRef(null),[r,f]=n.exports.useState({type:"FeatureCollection",features:[]}),[p,y]=n.exports.useState("auto"),[b,x]=n.exports.useState(),[C,I]=n.exports.useState([]),{fetchOverpass:L,loadingOverpass:g}=Se();n.exports.useEffect(()=>{setTimeout(()=>{var l;console.log(window.location.hash),!!window.location.hash.endsWith("/0/0")&&(console.log("geolocateControlRef trigger"),(l=a.current)==null||l.trigger())},500)},[]);const S=n.exports.useCallback(l=>{const c=l.target.getCenter(),h=l.target.getZoom();s({zoom:h,latitude:c.lat,longitude:c.lng,bearing:0,pitch:0,padding:{top:0,bottom:0,left:0,right:0}})},[]),w=n.exports.useCallback(l=>{s(l.viewState)},[]),m=n.exports.useCallback(l=>{s(l.viewState)},[]);n.exports.useEffect(()=>{(async()=>{if(!i)return;const l=i,c=await L(l.latitude,l.longitude,l.zoom);f(c)})()},[i]);const k=n.exports.useCallback(l=>{var F;y("pointer");const{features:c,point:{x:h,y:E}}=l,O=c&&c[0];O?((F=t.current)==null||F.setFeatureState({source:"buildings-source",id:O.id},{hover:!0}),x({feature:O,x:h,y:E})):x(void 0)},[]),R=n.exports.useCallback(l=>{var c;y("auto"),(c=t.current)==null||c.querySourceFeatures("buildings-source").map(h=>{var E;(E=t.current)==null||E.setFeatureState({source:"buildings-source",id:h.id},{hover:!1})}),x(void 0)},[]),u=n.exports.useCallback(l=>{var h;N();const c=l.features&&l.features[0];!c||((h=t.current)==null||h.setFeatureState({source:"buildings-source",id:c.id},{select:!0}),I([c]))},[]),N=n.exports.useCallback(()=>{var l;(l=t.current)==null||l.querySourceFeatures("buildings-source").map(c=>{var h;(h=t.current)==null||h.setFeatureState({source:"buildings-source",id:c.id},{select:!1})}),I([])},[]),A=n.exports.useMemo(()=>{let l=20;return e&&(l=e.zoom<18?15:e.zoom<19?20:30),r.features.map((c,h)=>c.properties?o(ne,{style:{cursor:"pointer"},longitude:c.properties.center[0],latitude:c.properties.center[1],anchor:"center",children:c.properties.userIconHref.length>0?o("img",{src:c.properties.userIconHref,style:{width:l+"px",height:l+"px"}}):o("span",{dangerouslySetInnerHTML:{__html:ae(c.properties.user||"noname",l)}})},`marker-${h}`):null)},[r,e]);return d("div",{children:[o(we,{}),d("div",{style:{zIndex:1,position:"absolute",top:0,left:0,height:"100vh",width:"100vw",display:"flex",flexDirection:"column"},children:[C.length>0&&o("div",{style:{zIndex:200,position:"absolute",top:"44px",left:0,width:"100vw",backgroundColor:"rgba(255, 255, 255, 0.9)"},children:o("div",{style:{padding:"10px"},children:C.map(l=>o(Ce,{feature:l,onCancel:N,onSubmit:N},l.id))})}),d(ie,J(M({ref:t},e),{onMove:w,onMoveEnd:m,onLoad:S,interactiveLayerIds:["buildings-layer-fill"],onClick:u,onMouseEnter:k,onMouseLeave:R,dragRotate:!1,boxZoom:!1,hash:!0,cursor:p,mapLib:le,style:{width:"100%",height:"100%"},mapStyle:Ee,children:[o(ce,{id:"buildings-source",type:"geojson",data:r,children:o(de,M({},Le))}),o(pe,{position:"top-left",style:{marginTop:"55px"},showCompass:!1}),o(ue,{ref:a,position:"top-left",showUserLocation:!0,showAccuracyCircle:!1,trackUserLocation:!1,positionOptions:{enableHighAccuracy:!0},fitBoundsOptions:{zoom:17}}),o("div",{className:"fa-2xl",style:{zIndex:100,display:"flex",position:"absolute",top:"50%",left:"50%",textAlign:"center",verticalAlign:"middle"},children:!e||(e==null?void 0:e.zoom)&&e.zoom<16?o(z,{size:"2x",icon:ge}):g?o(z,{size:"2x",icon:fe,spin:!0}):o(z,{size:"2x",icon:he})}),A,b&&d("div",{className:"tooltip",style:{zIndex:10,background:"rgba(255, 255, 255, 0.7)",padding:"5px",width:"250px",position:"absolute",left:b.x+5,top:b.y+5},children:[o(V,{feature:b.feature}),o("br",{}),o($,{feature:b.feature})]})]}))]})]})}window.Buffer=me.Buffer;ye.render(o(be.StrictMode,{children:o(Ae,{})}),document.getElementById("root"));
