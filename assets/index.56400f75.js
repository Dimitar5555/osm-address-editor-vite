var K=Object.defineProperty,W=Object.defineProperties;var X=Object.getOwnPropertyDescriptors;var q=Object.getOwnPropertySymbols;var Y=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable;var H=(t,e,s)=>e in t?K(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,I=(t,e)=>{for(var s in e||(e={}))Y.call(e,s)&&H(t,s,e[s]);if(q)for(var s of q(e))Z.call(e,s)&&H(t,s,e[s]);return t},J=(t,e)=>W(t,X(e));import{j as D,r,d as v,o as Q,p as ee,c as te,b as oe,m as se,M as re,t as ne,a as ae,e as ie,S as le,L as ce,N as de,G as pe,F as R,f as ue,g as ge,h as fe,i as he,R as me,k as ye}from"./vendor.a5335d74.js";const be=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const f of a.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&i(f)}).observe(document,{childList:!0,subtree:!0});function s(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerpolicy&&(a.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?a.credentials="include":n.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(n){if(n.ep)return;n.ep=!0;const a=s(n);fetch(n.href,a)}};be();const o=D.exports.jsx,u=D.exports.jsxs,F=D.exports.Fragment,V=()=>{const[t,e]=r.exports.useState(!1);r.exports.useEffect(()=>{e(v.exports.isLoggedIn())},[]);const s=r.exports.useCallback(()=>{(async()=>(await v.exports.login({mode:"popup",clientId:"q9sRK4UuNqv3_HLE8E7m2-wUAKS3XJSFWb9apehpAqE",scopes:["read_prefs","write_api","write_notes"],redirectUrl:window.location.href.replace(window.location.hash,"")}),e(v.exports.isLoggedIn()),window.location.reload()))()},[]),i=r.exports.useCallback(()=>{(async()=>(v.exports.logout(),e(!1)))()},[]);return o(F,{children:t?o("button",{style:{height:"44px"},className:"button py-1 px-1 border-transparent border-4 bg-gray-300 text-gray-900 hover:text-gray-500",onClick:i,children:"logout"}):o("button",{style:{height:"44px"},className:"button py-1 px-1 border-transparent border-4 bg-gray-300 text-gray-900 hover:text-gray-500",onClick:s,children:"login"})})},xe=()=>{const[t,e]=r.exports.useState(!1),[s,i]=r.exports.useState(void 0);return r.exports.useEffect(()=>{e(v.exports.isLoggedIn())},[]),r.exports.useEffect(()=>{!t||(async()=>{const n=await v.exports.getUser("me");i(n)})()},[t]),o(F,{children:s?o("img",{style:{width:"44px",height:"44px"},src:s.img.href,alt:s.display_name,title:s.display_name}):o("img",{})})},ve=()=>{const[t,e]=r.exports.useState(!1),[s,i]=r.exports.useState(void 0);return r.exports.useEffect(()=>{e(v.exports.isLoggedIn())},[]),r.exports.useEffect(()=>{!t||(async()=>{const n=await v.exports.getUser("me");i(n)})()},[t]),u("div",{style:{zIndex:100,position:"relative",top:0,left:0,height:"44px",display:"flex",flexDirection:"row",backgroundColor:"rgba(0, 255, 255, 0.9)"},children:[u("div",{children:[o("h1",{className:"text-4xl font-bold",style:{display:"inline",margin:"0px"},children:"OSM address editor"}),s?u("span",{style:{marginLeft:"10px"},children:["Hi ",s==null?void 0:s.display_name,", You have"," ",s==null?void 0:s.changesets.count," changesets."]}):o("span",{style:{marginLeft:"10px"},children:"Please logged in as OSM user."})]}),u("div",{style:{display:"flex",flex:1,justifyContent:"end"},children:[o("div",{children:o(xe,{})}),o("div",{children:o(V,{})})]})]})},z={type:"FeatureCollection",features:[]},we=()=>{const[t,e]=r.exports.useState(!1);return{fetchOverpass:r.exports.useCallback(async(i,n,a)=>{var C,N;if(console.log(a),a<16)return z;let f=300;if(a>17&&(f=200),a>18&&(f=100),a>19&&(f=50),t)return z;e(!0),console.log("overpass: loading...");let p="[out:json]";p+=`[timeout:25];
`,p+='way["building"]',p+=`(around:${f},${i},${n});
`,p+="out meta geom;",console.log(p);const y=await fetch(`https://lz4.overpass-api.de/api/interpreter?data=${encodeURIComponent(p)}`,{});if(y.status!==200)return e(!1),z;const b=await y.json();console.log("overpass json elements: ",b.elements);const x=Q(b);console.log("overpass osmtogeojson raw: ",x);for await(const g of x.features){if(!g.properties)continue;g.id=g.properties.id.split("/")[1];const S=(C=b.elements.filter(h=>g.id?typeof g.id=="number"?h.id===g.id:h.id===parseInt(g.id):!1))==null?void 0:C[0];if(S&&(g.properties.tags=S.tags,g.properties.nodes=S.nodes),g.geometry.type==="Polygon"){const h=ee(g.geometry.coordinates);var k=te(h);g.properties.center=k.geometry.coordinates}const d=g.properties.uid;if(d){let h=localStorage.getItem(d+"-icon");if(h===null){const w=await v.exports.getUser(d);((N=w.img)==null?void 0:N.href)?(h=w.img.href,localStorage.setItem(d+"-icon",w.img.href)):localStorage.setItem(d+"-icon","")}g.properties.userIconHref=h||""}}return console.log("overpass osmtogeojson converted: ",x),console.log("overpass: loaded."),e(!1),x},[]),loadingOverpass:t}},B=({feature:t})=>{var s;const e=JSON.parse((s=t.properties)==null?void 0:s.center);return u(F,{children:[u("span",{className:"longitude",children:["Longitude: ",Math.round(e[0]*1e4)/1e4]}),", ",u("span",{className:"latitude",children:["Latitude: ",Math.round(e[1]*1e4)/1e4," "]})]})},L={key:"addr:postcode",displayName:"\u90F5\u4FBF\u756A\u53F7",placeholder:"101-0021"},G=[{key:"addr:province",displayName:"\u90FD\u9053\u5E9C\u770C",placeholder:"\u6771\u4EAC\u90FD"},{key:"addr:city",displayName:"\u5E02\u533A\u753A\u6751",placeholder:"\u5343\u4EE3\u7530\u533A"},{key:"addr:quarter",displayName:"\u5730\u540D",placeholder:"\u5916\u795E\u7530"}],P=[{key:"addr:neighbourhood",displayName:"\u4E01\u76EE",placeholder:"1\u4E01\u76EE"},{key:"addr:block_number",displayName:"\u756A\u5730",placeholder:"17"},{key:"addr:housenumber",displayName:"\u53F7",placeholder:"6",prefix:"-"}];[L.key,...G.map(t=>t.key),...P.map(t=>t.key)];const $=({feature:t})=>{var e,s;return u(F,{children:[((e=t.properties)==null?void 0:e[L.key])&&o("span",{className:"addr:postcode",children:(s=t.properties)==null?void 0:s[L.key]})," ",G.map(i=>{var n,a;return((n=t.properties)==null?void 0:n[i.key])?o("span",{className:i.key,children:(a=t.properties)==null?void 0:a[i.key]},i.key):null})," ",P.map(i=>{var n,a,f;return((n=t.properties)==null?void 0:n[i.key])?u("span",{className:i.key,children:[(a=i.prefix)!=null?a:i.prefix,(f=t.properties)==null?void 0:f[i.key]]},i.key):null})]})},Se=()=>({detectCountry:r.exports.useCallback(async(e,s)=>{const n=await(await fetch("https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_0_countries.geojson")).json();for(const a of n.features)if(oe([e,s],a.geometry))return console.log("country: ",a.properties),a},[])}),ke={attribution:"https://yuiseki.github.io/osm-address-editor-vite/",host:"https://yuiseki.github.io/osm-address-editor-vite/",created_by:"osm-address-editor-vite",locale:navigator.language,comment:"Update address"},T=({feature:t,fieldName:e,label:s,placeholder:i})=>{var p;const[n,a]=r.exports.useState((p=t.properties)==null?void 0:p[e]);r.exports.useEffect(()=>{var y;a((y=t.properties)==null?void 0:y[e])},[t]);const f=r.exports.useCallback(y=>{a(y.currentTarget.value)},[]);return u("div",{className:"w-full md:w-1/6 py-1 px-2 mb-6 md:mb-0",children:[o("label",{className:"block tracking-wide text-gray-700 text-xs font-bold mb-2",htmlFor:e,children:s||e}),o("input",{className:"appearance-none block w-full leading-tight rounded py-2 px-1 border border-gray-300 bg-gray-100 text-black placeholder-gray-500 placeholder-opacity-50 focus:outline-none focus:bg-white focus:border-gray-500",id:e,name:e,type:"text",placeholder:i,value:n,onChange:f})]})},Ce=({feature:t,onCancel:e,onSubmit:s})=>{var S;const{detectCountry:i}=Se(),n=JSON.parse((S=t.properties)==null?void 0:S.center),[a,f]=r.exports.useState(),[p,y]=r.exports.useState(t),[b,x]=r.exports.useState(!1),[k,C]=r.exports.useState(!1);r.exports.useEffect(()=>{C(v.exports.isLoggedIn())},[]),r.exports.useEffect(()=>{(async()=>{const d=await i(n[0],n[1]);f(d.properties.ISO_A2)})()},[t]),r.exports.useEffect(()=>{console.log(p.properties)},[p]);const N=r.exports.useCallback(async()=>{console.info("openReverseGeocoder",[n[0],n[1]]);const d=await se.openReverseGeocoder([n[0],n[1]]);console.info("openReverseGeocoder",d),y(h=>{const w={properties:I({"addr:province":d.prefecture,"addr:city":d.city},h.properties)};return I(I({},h),w)})},[]),g=r.exports.useCallback(async d=>{var E,A,l;x(!0),d.preventDefault();const h=new FormData(d.currentTarget),w=JSON.parse((E=t.properties)==null?void 0:E.tags);h.forEach((c,m)=>{typeof c=="string"&&c.length>0&&(w[m]=c)});const O={type:"way",id:t.id,version:(A=t.properties)==null?void 0:A.version,tags:w,nodes:JSON.parse((l=t.properties)==null?void 0:l.nodes)};console.info(JSON.stringify(O,null,2));const _={create:[],modify:[O],delete:[]};await v.exports.uploadChangeset(ke,_),x(!1),window.alert(`Successfully updated OpenStreetMap!!!
 Wait a minutes to apply to the map...`),s()},[t]);return o("div",{children:p.properties&&u(F,{children:[u("div",{children:["OSM:"," ",o("a",{className:"underline text-blue-600 hover:text-blue-800 visited:text-purple-600",href:"https://www.openstreetmap.org/"+p.properties.id,target:"_blank",children:p.properties.id})," | ",o(B,{feature:p}),a==="JP"&&u("span",{children:[" | ","Address:"," ",o("span",{className:"underline",children:o($,{feature:p})})]})]}),a==="JP"?u("form",{onSubmit:g,children:[u("div",{className:"flex flex-wrap",children:[o(T,{feature:p,fieldName:L.key,label:L.displayName,placeholder:L.placeholder}),G.map(d=>o(T,{feature:p,fieldName:d.key,label:d.displayName,placeholder:d.placeholder},d.key))]}),o("div",{className:"flex flex-wrap",children:P.map(d=>o(T,{feature:p,fieldName:d.key,label:d.displayName,placeholder:d.placeholder},d.key))}),o("div",{className:"flex flex-wrap",children:u("div",{className:"w-full py-2 px-2 mb-6 md:mb-0",children:[o("button",{type:"button",onClick:e,className:"button rounded mr-4 py-2 px-3  bg-gray-200 text-red-600 hover:text-red-800",children:"Cancel"}),o("button",{type:"button",onClick:N,className:"button rounded mr-4 py-2 px-3 bg-green-300 text-gray-800 hover:text-white",children:"Load address from coordinates"}),o("button",{disabled:!k||b,className:"button rounded mr-2 py-2 px-3 bg-blue-300 text-gray-800 disabled:bg-blue-100 disabled:text-gray-400 hover:text-white",children:"Submit to OpenStreetMap!"}),!k&&u(F,{children:[o("span",{className:"mr-2 underline text-red-600",children:"Require logged in before you submit data to OpenStreetMap"}),o(V,{})]})]})})]}):o("div",{className:"flex flex-wrap",children:o("div",{className:"w-full py-2 px-2 mb-6 md:mb-0",children:o("button",{type:"button",onClick:e,className:"button rounded mr-4 py-2 px-3  bg-gray-200 text-red-600 hover:text-red-800",children:"Cancel"})})})]})})};function Ne(t,e){const[s,i]=r.exports.useState(t);return r.exports.useEffect(()=>{const n=setTimeout(()=>{i(t)},e);return()=>{clearTimeout(n)}},[t,e]),s}const Ee={version:8,sources:{"raster-tiles":{type:"raster",tiles:["https://a.tile.openstreetmap.org/{z}/{x}/{y}.png","https://b.tile.openstreetmap.org/{z}/{x}/{y}.png","https://c.tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:"\xA9 OpenStreetMap contributors"}},layers:[{id:"osm-tiles",type:"raster",source:"raster-tiles",minzoom:0,maxzoom:20}]},Ie={id:"buildings-layer-fill",type:"fill",source:"buildings-source",paint:{"fill-color":["case",["boolean",["feature-state","select"],!1],"green",["all",["boolean",["has","addr:postcode"],!1],["boolean",["has","addr:province"],!1],["boolean",["has","addr:city"],!1],["boolean",["has","addr:quarter"],!1],["boolean",["has","addr:neighbourhood"],!1],["boolean",["has","addr:block_number"],!1],["boolean",["has","addr:housenumber"],!1]],"blue",["any",["boolean",["has","addr:postcode"],!1],["boolean",["has","addr:province"],!1],["boolean",["has","addr:city"],!1],["boolean",["has","addr:quarter"],!1],["boolean",["has","addr:neighbourhood"],!1],["boolean",["has","addr:block_number"],!1],["boolean",["has","addr:housenumber"],!1]],"yellow","red"],"fill-opacity":["case",["boolean",["feature-state","select"],!1],.8,["boolean",["feature-state","hover"],!1],.8,.4]},filter:["==","$type","Polygon"]};function Le(){const t=r.exports.useRef(null),[e,s]=r.exports.useState(),i=Ne(e,1e3),n=r.exports.useRef(null),[a,f]=r.exports.useState({type:"FeatureCollection",features:[]}),[p,y]=r.exports.useState("auto"),[b,x]=r.exports.useState(),[k,C]=r.exports.useState([]),{fetchOverpass:N,loadingOverpass:g}=we();r.exports.useEffect(()=>{setTimeout(()=>{var l;console.log(window.location.hash),!!window.location.hash.endsWith("/0/0")&&(console.log("geolocateControlRef trigger"),(l=n.current)==null||l.trigger())},500)},[]);const S=r.exports.useCallback(l=>{const c=l.target.getCenter(),m=l.target.getZoom();s({zoom:m,latitude:c.lat,longitude:c.lng,bearing:0,pitch:0,padding:{top:0,bottom:0,left:0,right:0}})},[]),d=r.exports.useCallback(l=>{s(l.viewState)},[]),h=r.exports.useCallback(l=>{s(l.viewState)},[]);r.exports.useEffect(()=>{(async()=>{if(!i)return;const l=i,c=await N(l.latitude,l.longitude,l.zoom);f(c)})()},[i]);const w=r.exports.useCallback(l=>{var U;y("pointer");const{features:c,point:{x:m,y:M}}=l,j=c&&c[0];j?((U=t.current)==null||U.setFeatureState({source:"buildings-source",id:j.id},{hover:!0}),x({feature:j,x:m,y:M})):x(void 0)},[]),O=r.exports.useCallback(l=>{var c;y("auto"),(c=t.current)==null||c.querySourceFeatures("buildings-source").map(m=>{var M;(M=t.current)==null||M.setFeatureState({source:"buildings-source",id:m.id},{hover:!1})}),x(void 0)},[]),_=r.exports.useCallback(l=>{var m;E();const c=l.features&&l.features[0];!c||((m=t.current)==null||m.setFeatureState({source:"buildings-source",id:c.id},{select:!0}),C([c]))},[]),E=r.exports.useCallback(()=>{var l;(l=t.current)==null||l.querySourceFeatures("buildings-source").map(c=>{var m;(m=t.current)==null||m.setFeatureState({source:"buildings-source",id:c.id},{select:!1})}),C([])},[]),A=r.exports.useMemo(()=>{let l=20;return e&&(l=e.zoom<18?15:e.zoom<19?20:30),a.features.map((c,m)=>c.properties?o(re,{style:{cursor:"pointer"},longitude:c.properties.center[0],latitude:c.properties.center[1],anchor:"center",children:c.properties.userIconHref.length>0?o("img",{src:c.properties.userIconHref,style:{width:l+"px",height:l+"px"}}):o("span",{dangerouslySetInnerHTML:{__html:ne(c.properties.user||"noname",l)}})},`marker-${m}`):null)},[a,e]);return u("div",{children:[o(ve,{}),u("div",{style:{zIndex:1,position:"absolute",top:0,left:0,height:"100vh",width:"100vw",display:"flex",flexDirection:"column"},children:[k.length>0&&o("div",{style:{zIndex:200,position:"absolute",top:"44px",left:0,width:"100vw",backgroundColor:"rgba(255, 255, 255, 0.9)"},children:o("div",{style:{padding:"10px"},children:k.map(l=>o(Ce,{feature:l,onCancel:E,onSubmit:E},l.id))})}),u(ae,J(I({ref:t},e),{onMove:d,onMoveEnd:h,onLoad:S,interactiveLayerIds:["buildings-layer-fill"],onClick:_,onMouseEnter:w,onMouseLeave:O,dragRotate:!1,boxZoom:!1,hash:!0,cursor:p,mapLib:ie,style:{width:"100%",height:"100%"},mapStyle:Ee,children:[o(le,{id:"buildings-source",type:"geojson",data:a,children:o(ce,I({},Ie))}),o(de,{position:"top-left",style:{marginTop:"55px"},showCompass:!1}),o(pe,{ref:n,position:"top-left",showUserLocation:!0,showAccuracyCircle:!1,trackUserLocation:!1,positionOptions:{enableHighAccuracy:!0},fitBoundsOptions:{zoom:17}}),o("div",{className:"fa-2xl",style:{zIndex:100,display:"flex",position:"absolute",top:"50%",left:"50%",textAlign:"center",verticalAlign:"middle"},children:!e||(e==null?void 0:e.zoom)&&e.zoom<16?o(R,{size:"2x",icon:ue}):g?o(R,{size:"2x",icon:ge,spin:!0}):o(R,{size:"2x",icon:fe})}),A,b&&u("div",{className:"tooltip",style:{zIndex:10,background:"rgba(255, 255, 255, 0.7)",padding:"5px",width:"250px",position:"absolute",left:b.x+5,top:b.y+5},children:[o(B,{feature:b.feature}),o("br",{}),o($,{feature:b.feature})]})]}))]})]})}window.Buffer=he.Buffer;me.render(o(ye.StrictMode,{children:o(Le,{})}),document.getElementById("root"));
