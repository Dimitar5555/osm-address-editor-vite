var J=Object.defineProperty,K=Object.defineProperties;var W=Object.getOwnPropertyDescriptors;var j=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable;var R=(o,t,e)=>t in o?J(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,F=(o,t)=>{for(var e in t||(t={}))X.call(t,e)&&R(o,e,t[e]);if(j)for(var e of j(t))Z.call(t,e)&&R(o,e,t[e]);return o},z=(o,t)=>K(o,W(t));import{j as M,r,d as y,o as Y,p as Q,c as ee,m as te,M as oe,t as se,a as re,b as ne,F as D,f as ae,e as le,S as ie,L as ce,G as de,g as ue,R as pe,h as ge}from"./vendor.a6bf9e15.js";const he=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))l(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const p of i.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&l(p)}).observe(document,{childList:!0,subtree:!0});function e(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerpolicy&&(i.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?i.credentials="include":n.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function l(n){if(n.ep)return;n.ep=!0;const i=e(n);fetch(n.href,i)}};he();const s=M.exports.jsx,u=M.exports.jsxs,C=M.exports.Fragment,_=()=>{const[o,t]=r.exports.useState(!1);r.exports.useEffect(()=>{t(y.exports.isLoggedIn())},[]);const e=r.exports.useCallback(()=>{(async()=>(await y.exports.login({mode:"popup",clientId:"q9sRK4UuNqv3_HLE8E7m2-wUAKS3XJSFWb9apehpAqE",scopes:["read_prefs","write_api","write_notes"],redirectUrl:window.location.href.replace(window.location.hash,"")}),t(y.exports.isLoggedIn()),window.location.reload()))()},[]),l=r.exports.useCallback(()=>{(async()=>(y.exports.logout(),t(!1)))()},[]);return s(C,{children:o?s("button",{style:{height:"44px"},className:"button py-1 px-1 border-transparent border-4 bg-gray-300 text-gray-900 hover:text-gray-500",onClick:l,children:"logout"}):s("button",{style:{height:"44px"},className:"button py-1 px-1 border-transparent border-4 bg-gray-300 text-gray-900 hover:text-gray-500",onClick:e,children:"login"})})},fe=()=>{const[o,t]=r.exports.useState(!1),[e,l]=r.exports.useState(void 0);return r.exports.useEffect(()=>{t(y.exports.isLoggedIn())},[]),r.exports.useEffect(()=>{!o||(async()=>{const n=await y.exports.getUser("me");l(n)})()},[o]),s(C,{children:e?s("img",{style:{width:"44px",height:"44px"},src:e.img.href,alt:e.display_name,title:e.display_name}):s("img",{})})},me=()=>{const[o,t]=r.exports.useState(!1),[e,l]=r.exports.useState(void 0);return r.exports.useEffect(()=>{t(y.exports.isLoggedIn())},[]),r.exports.useEffect(()=>{!o||(async()=>{const n=await y.exports.getUser("me");l(n)})()},[o]),u("div",{style:{zIndex:100,position:"relative",top:0,left:0,height:"44px",display:"flex",flexDirection:"row",backgroundColor:"rgba(0, 255, 255, 0.9)"},children:[u("div",{children:[s("h1",{className:"text-4xl font-bold",style:{display:"inline",margin:"0px"},children:"OSM address editor"}),e?u("span",{style:{marginLeft:"10px"},children:["Hi ",e==null?void 0:e.display_name,", You have"," ",e==null?void 0:e.changesets.count," changesets."]}):s("span",{style:{marginLeft:"10px"},children:"Please logged in as OSM user."})]}),u("div",{style:{display:"flex",flex:1,justifyContent:"end"},children:[s("div",{children:s(fe,{})}),s("div",{children:s(_,{})})]})]})},ye=()=>{const[o,t]=r.exports.useState(!1);return{fetchOverpass:r.exports.useCallback(async(l,n,i)=>{var v;let p=300;p=i<18?300:i<19?150:50,t(!0),console.log("overpass: loading...");let g="[out:json]";g+=`[timeout:25];
`,g+='way["building"]',g+=`(around:${p},${l},${n});
`,g+="out meta geom;",console.log(g);const x=await fetch(`https://lz4.overpass-api.de/api/interpreter?data=${encodeURIComponent(g)}`,{});if(x.status!==200)return{type:"FeatureCollection",features:[]};const m=await x.json();console.log("overpass json elements: ",m.elements.length);const c=Y(m);console.log("overpass osmtogeojson raw: ",c);for await(const h of c.features){if(!h.properties)continue;if(h.id=h.properties.id.split("/")[1],h.geometry.type==="Polygon"){const w=Q(h.geometry.coordinates);var k=ee(w);h.properties.center=k.geometry.coordinates}const b=h.properties.uid;if(b){let w=localStorage.getItem(b+"-icon");if(w===null){const N=await y.exports.getUser(b);((v=N.img)==null?void 0:v.href)?(w=N.img.href,localStorage.setItem(b+"-icon",N.img.href)):localStorage.setItem(b+"-icon","")}h.properties.userIconHref=w||""}}return console.log("overpass osmtogeojson converted: ",c),console.log("overpass: loaded."),t(!1),c},[]),loadingOverpass:o}},I={key:"addr:postcode",displayName:"\u90F5\u4FBF\u756A\u53F7",placeholder:"101-0021"},H=[{key:"addr:province",displayName:"\u90FD\u9053\u5E9C\u770C",placeholder:"\u6771\u4EAC\u90FD"},{key:"addr:city",displayName:"\u5E02\u533A\u753A\u6751",placeholder:"\u5343\u4EE3\u7530\u533A"},{key:"addr:quarter",displayName:"\u5730\u540D",placeholder:"\u5916\u795E\u7530"}],U=[{key:"addr:neighbourhood",displayName:"\u4E01\u76EE",placeholder:"1\u4E01\u76EE"},{key:"addr:block_number",displayName:"\u756A\u5730",placeholder:"17"},{key:"addr:housenumber",displayName:"\u53F7",placeholder:"6",prefix:"-"}],E=({feature:o,fieldName:t,label:e,placeholder:l})=>{var g;const[n,i]=r.exports.useState((g=o.properties)==null?void 0:g[t]),p=r.exports.useCallback(x=>{i(x.currentTarget.value)},[]);return u("div",{className:"w-full md:w-1/6 py-1 px-2 mb-6 md:mb-0",children:[s("label",{className:"block tracking-wide text-gray-700 text-xs font-bold mb-2",htmlFor:t,children:e||t}),s("input",{className:"appearance-none block w-full leading-tight rounded py-2 px-1 border border-gray-300 bg-gray-100 text-black placeholder-gray-500 placeholder-opacity-50 focus:outline-none focus:bg-white focus:border-gray-500",id:t,name:t,type:"text",placeholder:l,value:n,onChange:p})]})},q=({feature:o})=>{var e;const t=JSON.parse((e=o.properties)==null?void 0:e.center);return u(C,{children:[u("span",{className:"longitude",children:["Longitude: ",Math.round(t[0]*1e4)/1e4]}),", ",u("span",{className:"latitude",children:["Latitude: ",Math.round(t[1]*1e4)/1e4," "]})]})},G=({feature:o})=>{var t;return u(C,{children:[s("span",{className:"addr:postcode",children:(t=o.properties)==null?void 0:t[I.key]})," ",H.map(e=>{var l;return s("span",{className:e.key,children:(l=o.properties)==null?void 0:l[e.key]},e.key)})," ",U.map(e=>{var l,n;return u("span",{className:e.key,children:[(l=e.prefix)!=null?l:e.prefix,(n=o.properties)==null?void 0:n[e.key]]},e.key)})]})},xe=({feature:o,onCancel:t})=>{var m;const e=JSON.parse((m=o.properties)==null?void 0:m.center),[l,n]=r.exports.useState(!1),[i,p]=r.exports.useState(!1);r.exports.useEffect(()=>{p(y.exports.isLoggedIn())},[]);const g=r.exports.useCallback(async()=>{console.info("openReverseGeocoder",[e[0],e[1]]);const c=await te.openReverseGeocoder([e[0],e[1]]);console.info("openReverseGeocoder",c)},[]),x=r.exports.useCallback(c=>{n(!0),c.preventDefault();const k=new FormData(c.currentTarget),v={};k.forEach((h,b)=>v[b]=h),console.info(JSON.stringify(v,null,2)),n(!1)},[]);return s("div",{children:o.properties&&u(C,{children:[u("div",{children:["OSM:"," ",s("a",{className:"underline text-blue-600 hover:text-blue-800 visited:text-purple-600",href:"https://www.openstreetmap.org/"+o.properties.id,target:"_blank",children:o.properties.id})," | ",s(q,{feature:o})," | ",u("span",{children:["Address:"," ",s("span",{className:"underline",children:s(G,{feature:o})})]})]}),u("form",{onSubmit:x,children:[u("div",{className:"flex flex-wrap",children:[s(E,{feature:o,fieldName:I.key,label:I.displayName,placeholder:I.placeholder}),H.map(c=>s(E,{feature:o,fieldName:c.key,label:c.displayName,placeholder:c.placeholder},c.key))]}),s("div",{className:"flex flex-wrap",children:U.map(c=>s(E,{feature:o,fieldName:c.key,label:c.displayName,placeholder:c.placeholder},c.key))}),s("div",{className:"flex flex-wrap",children:u("div",{className:"w-full py-2 px-2 mb-6 md:mb-0",children:[s("button",{type:"button",onClick:t,className:"button rounded mr-4 py-2 px-3  bg-gray-200 text-red-600 hover:text-red-800",children:"Cancel"}),s("button",{type:"button",onClick:g,className:"button rounded mr-4 py-2 px-3 bg-green-300 text-gray-800 hover:text-white",children:"Load address from coordinates (work in progress...)"}),s("button",{disabled:!i||l,className:"button rounded mr-2 py-2 px-3 bg-blue-300 text-gray-800 disabled:bg-blue-100 disabled:text-gray-400 hover:text-white",children:"Submit to OpenStreetMap (work in progress...)"}),!i&&u(C,{children:[s("span",{className:"mr-2 underline text-red-600",children:"Require logged in before you submit data to OpenStreetMap"}),s(_,{})]})]})})]})]})})};function be(o,t){const[e,l]=r.exports.useState(o);return r.exports.useEffect(()=>{const n=setTimeout(()=>{l(o)},t);return()=>{clearTimeout(n)}},[o,t]),e}const ve={id:"buildings-layer-fill",type:"fill",source:"buildings-source",paint:{"fill-color":["case",["boolean",["feature-state","select"],!1],"green",["boolean",["has","addr:province"],!1],"blue","pink"],"fill-opacity":["case",["boolean",["feature-state","select"],!1],.8,["boolean",["feature-state","hover"],!1],.8,.4]},filter:["==","$type","Polygon"]};function we(){const o=r.exports.useRef(null),[t,e]=r.exports.useState(),l=be(t,1e3),n=r.exports.useRef(null),[i,p]=r.exports.useState({type:"FeatureCollection",features:[]}),[g,x]=r.exports.useState("auto"),[m,c]=r.exports.useState(),[k,v]=r.exports.useState([]),{fetchOverpass:h,loadingOverpass:b}=ye();r.exports.useEffect(()=>{setTimeout(()=>{var a;console.log(window.location.hash),!!window.location.hash.endsWith("/0/0")&&(console.log("geolocateControlRef trigger"),(a=n.current)==null||a.trigger())},500)},[]);const w=r.exports.useCallback(async a=>{const d=a.target.getCenter(),f=a.target.getZoom(),S=await h(d.lat,d.lng,f);p(S)},[]),N=r.exports.useCallback(a=>{e(a.viewState)},[]),T=r.exports.useCallback(a=>{e(a.viewState)},[]);r.exports.useEffect(()=>{(async()=>{if(!l)return;const a=l,d=await h(a.latitude,a.longitude,a.zoom);p(d)})()},[l]);const V=r.exports.useCallback(a=>{var O;x("pointer");const{features:d,point:{x:f,y:S}}=a,L=d&&d[0];L?((O=o.current)==null||O.setFeatureState({source:"buildings-source",id:L.id},{hover:!0}),c({feature:L,x:f,y:S})):c(void 0)},[]),B=r.exports.useCallback(a=>{var d;x("auto"),(d=o.current)==null||d.querySourceFeatures("buildings-source").map(f=>{var S;(S=o.current)==null||S.setFeatureState({source:"buildings-source",id:f.id},{hover:!1})}),c(void 0)},[]),P=r.exports.useCallback(a=>{var f;A();const d=a.features&&a.features[0];!d||((f=o.current)==null||f.setFeatureState({source:"buildings-source",id:d.id},{select:!0}),v([d]))},[]),A=r.exports.useCallback(()=>{var a;(a=o.current)==null||a.querySourceFeatures("buildings-source").map(d=>{var f;(f=o.current)==null||f.setFeatureState({source:"buildings-source",id:d.id},{select:!1})}),v([])},[]),$=r.exports.useMemo(()=>{let a=15;return t&&(console.log(t.zoom),a=t.zoom<18?15:30),i.features.map((d,f)=>d.properties?s(oe,{style:{cursor:"pointer"},longitude:d.properties.center[0],latitude:d.properties.center[1],anchor:"center",children:d.properties.userIconHref.length>0?s("img",{src:d.properties.userIconHref,style:{width:a+"px",height:a+"px"}}):s("span",{dangerouslySetInnerHTML:{__html:se(d.properties.user||"noname",a)}})},`marker-${f}`):null)},[i,t]);return u("div",{children:[s(me,{}),u("div",{style:{zIndex:1,position:"absolute",top:0,left:0,height:"100vh",width:"100vw",display:"flex",flexDirection:"column"},children:[k.length>0&&s("div",{style:{zIndex:200,position:"absolute",top:"44px",left:0,height:"250px",width:"100vw",backgroundColor:"rgba(255, 255, 255, 0.9)"},children:s("div",{style:{padding:"10px"},children:k.map(a=>s(xe,{feature:a,onCancel:A},a.id))})}),u(re,z(F({ref:o},t),{onMove:N,onMoveEnd:T,onLoad:w,interactiveLayerIds:["buildings-layer-fill"],onClick:P,onMouseEnter:V,onMouseLeave:B,dragRotate:!1,boxZoom:!1,hash:!0,cursor:g,mapLib:ne,style:{width:"100%",height:"100%"},mapStyle:"https://raw.githubusercontent.com/geoloniamaps/basic/gh-pages/style.json",children:[s("div",{className:"fa-2xl",style:{zIndex:100,display:"flex",position:"absolute",top:"50%",left:"50%",textAlign:"center",verticalAlign:"middle"},children:b?s(D,{size:"2x",spin:!0,icon:ae}):s(D,{size:"2x",icon:le})}),s(ie,{id:"buildings-source",type:"geojson",data:i,children:s(ce,F({},ve))}),$,m&&u("div",{className:"tooltip",style:{zIndex:10,background:"rgba(255, 255, 255, 0.7)",padding:"5px",width:"250px",position:"absolute",left:m.x+5,top:m.y+5},children:[s(q,{feature:m.feature}),s("br",{}),s(G,{feature:m.feature})]}),s(de,{ref:n,position:"top-left",style:{marginTop:"55px"},showUserLocation:!0,showAccuracyCircle:!1,trackUserLocation:!1,positionOptions:{enableHighAccuracy:!0},fitBoundsOptions:{zoom:17}})]}))]})]})}window.Buffer=ue.Buffer;pe.render(s(ge.StrictMode,{children:s(we,{})}),document.getElementById("root"));
