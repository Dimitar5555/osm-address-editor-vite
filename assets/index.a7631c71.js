var V=Object.defineProperty,K=Object.defineProperties;var W=Object.getOwnPropertyDescriptors;var A=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable;var O=(o,s,e)=>s in o?V(o,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[s]=e,I=(o,s)=>{for(var e in s||(s={}))X.call(s,e)&&O(o,e,s[e]);if(A)for(var e of A(s))Y.call(s,e)&&O(o,e,s[e]);return o},j=(o,s)=>K(o,W(s));import{j as F,r,d as x,o as Z,p as Q,c as ee,m as te,M as oe,t as se,a as re,b as ne,F as R,f as ae,e as le,S as ie,L as ce,G as de,g as pe,R as ue,h as ge}from"./vendor.a6bf9e15.js";const he=function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const g of i.addedNodes)g.tagName==="LINK"&&g.rel==="modulepreload"&&a(g)}).observe(document,{childList:!0,subtree:!0});function e(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerpolicy&&(i.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?i.credentials="include":n.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=e(n);fetch(n.href,i)}};he();const t=F.exports.jsx,d=F.exports.jsxs,w=F.exports.Fragment,_=()=>{const[o,s]=r.exports.useState(!1);r.exports.useEffect(()=>{s(x.exports.isLoggedIn())},[]);const e=r.exports.useCallback(()=>{(async()=>(await x.exports.login({mode:"popup",clientId:"q9sRK4UuNqv3_HLE8E7m2-wUAKS3XJSFWb9apehpAqE",scopes:["read_prefs","write_api","write_notes"],redirectUrl:window.location.href.replace(window.location.hash,"")}),s(x.exports.isLoggedIn()),window.location.reload()))()},[]),a=r.exports.useCallback(()=>{(async()=>(x.exports.logout(),s(!1)))()},[]);return t(w,{children:o?t("button",{style:{height:"44px"},className:"button py-1 px-1 border-transparent border-4 bg-gray-300 text-gray-900 hover:text-gray-500",onClick:a,children:"logout"}):t("button",{style:{height:"44px"},className:"button py-1 px-1 border-transparent border-4 bg-gray-300 text-gray-900 hover:text-gray-500",onClick:e,children:"login"})})},fe=()=>{const[o,s]=r.exports.useState(!1),[e,a]=r.exports.useState(void 0);return r.exports.useEffect(()=>{s(x.exports.isLoggedIn())},[]),r.exports.useEffect(()=>{!o||(async()=>{const n=await x.exports.getUser("me");a(n)})()},[o]),t(w,{children:e?t("img",{style:{width:"44px",height:"44px"},src:e.img.href,alt:e.display_name,title:e.display_name}):t("img",{})})},me=()=>{const[o,s]=r.exports.useState(!1),[e,a]=r.exports.useState(void 0);return r.exports.useEffect(()=>{s(x.exports.isLoggedIn())},[]),r.exports.useEffect(()=>{!o||(async()=>{const n=await x.exports.getUser("me");a(n)})()},[o]),d("div",{style:{zIndex:100,position:"relative",top:0,left:0,height:"44px",display:"flex",flexDirection:"row",backgroundColor:"rgba(0, 255, 255, 0.9)"},children:[d("div",{children:[t("h1",{className:"text-4xl font-bold",style:{display:"inline",margin:"0px"},children:"OSM address editor"}),e?d("span",{style:{marginLeft:"10px"},children:["Hi ",e==null?void 0:e.display_name,", You have"," ",e==null?void 0:e.changesets.count," changesets."]}):t("span",{style:{marginLeft:"10px"},children:"Please logged in as OSM user."})]}),d("div",{style:{display:"flex",flex:1,justifyContent:"end"},children:[t("div",{children:t(fe,{})}),t("div",{children:t(_,{})})]})]})},xe=()=>({fetchOverpass:r.exports.useCallback(async(s,e)=>{var f;console.log("overpass: loading...");let a="[out:json]";a+=`[timeout:25];
`,a+='way["building"]',a+=`(around:${300},${s},${e});
`,a+="out meta geom;",console.log(a);const i=await(await fetch(`https://lz4.overpass-api.de/api/interpreter?data=${encodeURIComponent(a)}`,{})).json();console.log(i),console.log("overpass: ",i.elements.length);const g=Z(i);console.log("overpass geojson raw: ",g);for await(const u of g.features){if(!u.properties)continue;if(u.id=u.properties.id.split("/")[1],u.geometry.type==="Polygon"){const m=Q(u.geometry.coordinates);var y=ee(m);u.properties.center=y.geometry.coordinates}const c=u.properties.uid;if(c){let m=localStorage.getItem(c+"-icon");if(m===null){const b=await x.exports.getUser(c);((f=b.img)==null?void 0:f.href)?(m=b.img.href,localStorage.setItem(c+"-icon",b.img.href)):localStorage.setItem(c+"-icon","")}u.properties.userIconHref=m||""}}return console.log("overpass geojson converted: ",g),console.log("overpass: loaded."),g},[])}),N={key:"addr:postcode",displayName:"\u90F5\u4FBF\u756A\u53F7",placeholder:"101-0021"},D=[{key:"addr:province",displayName:"\u90FD\u9053\u5E9C\u770C",placeholder:"\u6771\u4EAC\u90FD"},{key:"addr:city",displayName:"\u5E02\u533A\u753A\u6751",placeholder:"\u5343\u4EE3\u7530\u533A"},{key:"addr:quarter",displayName:"\u5730\u540D",placeholder:"\u5916\u795E\u7530"}],H=[{key:"addr:neighbourhood",displayName:"\u4E01\u76EE",placeholder:"1\u4E01\u76EE"},{key:"addr:block_number",displayName:"\u756A\u5730",placeholder:"17"},{key:"addr:housenumber",displayName:"\u53F7",placeholder:"6",prefix:"-"}],L=({feature:o,fieldName:s,label:e,placeholder:a})=>{var y;const[n,i]=r.exports.useState((y=o.properties)==null?void 0:y[s]),g=r.exports.useCallback(f=>{i(f.currentTarget.value)},[]);return d("div",{className:"w-full md:w-1/6 py-1 px-2 mb-6 md:mb-0",children:[t("label",{className:"block tracking-wide text-gray-700 text-xs font-bold mb-2",htmlFor:s,children:e||s}),t("input",{className:"appearance-none block w-full leading-tight rounded py-2 px-1 border border-gray-300 bg-gray-100 text-black placeholder-gray-500 placeholder-opacity-50 focus:outline-none focus:bg-white focus:border-gray-500",id:s,name:s,type:"text",placeholder:a,value:n,onChange:g})]})},U=({feature:o})=>{var e;const s=JSON.parse((e=o.properties)==null?void 0:e.center);return d(w,{children:[d("span",{className:"longitude",children:["Longitude: ",Math.round(s[0]*1e4)/1e4]}),", ",d("span",{className:"latitude",children:["Latitude: ",Math.round(s[1]*1e4)/1e4," "]})]})},q=({feature:o})=>{var s;return d(w,{children:[t("span",{className:"addr:postcode",children:(s=o.properties)==null?void 0:s[N.key]})," ",D.map(e=>{var a;return t("span",{className:e.key,children:(a=o.properties)==null?void 0:a[e.key]})})," ",H.map(e=>{var a,n;return d("span",{className:e.key,children:[(a=e.prefix)!=null?a:e.prefix,(n=o.properties)==null?void 0:n[e.key]]})})]})},ye=({feature:o,onCancel:s})=>{var u;const e=JSON.parse((u=o.properties)==null?void 0:u.center),[a,n]=r.exports.useState(!1),[i,g]=r.exports.useState(!1);r.exports.useEffect(()=>{g(x.exports.isLoggedIn())},[]);const y=r.exports.useCallback(async()=>{console.info("openReverseGeocoder",[e[0],e[1]]);const c=await te.openReverseGeocoder([e[0],e[1]]);console.info("openReverseGeocoder",c)},[]),f=r.exports.useCallback(c=>{n(!0),c.preventDefault();const m=new FormData(c.currentTarget),b={};m.forEach((v,S)=>b[S]=v),console.info(JSON.stringify(b,null,2)),n(!1)},[]);return t("div",{children:o.properties&&d(w,{children:[d("div",{children:["OSM:"," ",t("a",{className:"underline text-blue-600 hover:text-blue-800 visited:text-purple-600",href:"https://www.openstreetmap.org/"+o.properties.id,target:"_blank",children:o.properties.id})," | ",t(U,{feature:o})," | ",d("span",{children:["Address:"," ",t("span",{className:"underline",children:t(q,{feature:o})})]})]}),d("form",{onSubmit:f,children:[d("div",{className:"flex flex-wrap",children:[t(L,{feature:o,fieldName:N.key,label:N.displayName,placeholder:N.placeholder}),D.map(c=>t(L,{feature:o,fieldName:c.key,label:c.displayName,placeholder:c.placeholder}))]}),t("div",{className:"flex flex-wrap",children:H.map(c=>t(L,{feature:o,fieldName:c.key,label:c.displayName,placeholder:c.placeholder}))}),t("div",{className:"flex flex-wrap",children:d("div",{className:"w-full py-2 px-2 mb-6 md:mb-0",children:[t("button",{type:"button",onClick:s,className:"button rounded mr-4 py-2 px-3  bg-gray-200 text-red-600 hover:text-red-800",children:"Cancel"}),t("button",{type:"button",onClick:y,className:"button rounded mr-4 py-2 px-3 bg-green-300 text-gray-800 hover:text-white",children:"Load address from coordinates (work in progress...)"}),t("button",{disabled:!i||a,className:"button rounded mr-2 py-2 px-3 bg-blue-300 text-gray-800 disabled:bg-blue-100 disabled:text-gray-400 hover:text-white",children:"Submit to OpenStreetMap (work in progress...)"}),!i&&d(w,{children:[t("span",{className:"mr-2 underline text-red-600",children:"Require logged in before you submit data to OpenStreetMap"}),t(_,{})]})]})})]})]})})},be={id:"buildings-layer-fill",type:"fill",source:"buildings-source",paint:{"fill-color":["case",["boolean",["feature-state","select"],!1],"green",["boolean",["has","addr:province"],!1],"blue","pink"],"fill-opacity":["case",["boolean",["feature-state","select"],!1],.8,["boolean",["feature-state","hover"],!1],.8,.4]},filter:["==","$type","Polygon"]};function ve(){const o=r.exports.useRef(null),[s,e]=r.exports.useState({}),a=r.exports.useRef(null),[n,i]=r.exports.useState({type:"FeatureCollection",features:[]}),[g,y]=r.exports.useState("auto"),[f,u]=r.exports.useState(),[c,m]=r.exports.useState([]),[b,v]=r.exports.useState(),{fetchOverpass:S}=xe();r.exports.useEffect(()=>{setTimeout(()=>{var l;console.log(window.location.hash),window.location.hash.endsWith("/0/0")&&(console.log("geolocateControlRef trigger"),(l=a.current)==null||l.trigger())},500)},[]);const z=r.exports.useCallback(async l=>{const p=l.target.getCenter();v(!0);const h=await S(p.lat,p.lng);i(h),v(!1)},[]),G=r.exports.useCallback(l=>{e(l.viewState)},[]),T=r.exports.useCallback(async l=>{e(l.viewState);const p=l.viewState;if(!b){v(!0);const h=await S(p.latitude,p.longitude);i(h),v(!1)}},[]),B=r.exports.useCallback(l=>{var M;y("pointer");const{features:p,point:{x:h,y:k}}=l,C=p&&p[0];C?((M=o.current)==null||M.setFeatureState({source:"buildings-source",id:C.id},{hover:!0}),u({feature:C,x:h,y:k})):u(void 0)},[]),P=r.exports.useCallback(l=>{var p;y("auto"),(p=o.current)==null||p.querySourceFeatures("buildings-source").map(h=>{var k;(k=o.current)==null||k.setFeatureState({source:"buildings-source",id:h.id},{hover:!1})}),u(void 0)},[]),$=r.exports.useCallback(l=>{var h;E();const p=l.features&&l.features[0];!p||((h=o.current)==null||h.setFeatureState({source:"buildings-source",id:p.id},{select:!0}),m([p]))},[]),E=r.exports.useCallback(()=>{var l;(l=o.current)==null||l.querySourceFeatures("buildings-source").map(p=>{var h;(h=o.current)==null||h.setFeatureState({source:"buildings-source",id:p.id},{select:!1})}),m([])},[]),J=r.exports.useMemo(()=>n.features.map((l,p)=>l.properties?t(oe,{style:{cursor:"pointer"},longitude:l.properties.center[0],latitude:l.properties.center[1],anchor:"center",children:l.properties.userIconHref.length>0?t("img",{src:l.properties.userIconHref,style:{width:"30px",height:"30px"}}):t("span",{dangerouslySetInnerHTML:{__html:se(l.properties.user||"noname",30)}})},`marker-${p}`):null),[n]);return d("div",{children:[t(me,{}),d("div",{style:{zIndex:1,position:"absolute",top:0,left:0,height:"100vh",width:"100vw",display:"flex",flexDirection:"column"},children:[c.length>0&&t("div",{style:{zIndex:200,position:"absolute",top:"44px",left:0,height:"250px",width:"100vw",backgroundColor:"rgba(255, 255, 255, 0.9)"},children:t("div",{style:{padding:"10px"},children:c.map(l=>t(ye,{feature:l,onCancel:E},l.id))})}),d(re,j(I({ref:o},s),{onMove:G,onMoveEnd:T,onLoad:z,interactiveLayerIds:["buildings-layer-fill"],onClick:$,onMouseEnter:B,onMouseLeave:P,dragRotate:!1,boxZoom:!1,hash:!0,cursor:g,mapLib:ne,style:{width:"100%",height:"100%"},mapStyle:"https://raw.githubusercontent.com/geoloniamaps/basic/gh-pages/style.json",children:[t("div",{className:"fa-2xl",style:{zIndex:100,display:"flex",position:"absolute",top:"50%",left:"50%",textAlign:"center",verticalAlign:"middle"},children:b?t(R,{size:"2x",spin:!0,icon:ae}):t(R,{size:"2x",icon:le})}),t(ie,{id:"buildings-source",type:"geojson",data:n,children:t(ce,I({},be))}),J,f&&d("div",{className:"tooltip",style:{zIndex:10,background:"rgba(255, 255, 255, 0.7)",padding:"5px",width:"250px",position:"absolute",left:f.x+5,top:f.y+5},children:[t(U,{feature:f.feature}),t("br",{}),t(q,{feature:f.feature})]}),t(de,{ref:a,position:"top-left",style:{marginTop:"55px"},showUserLocation:!0,showAccuracyCircle:!1,trackUserLocation:!1,positionOptions:{enableHighAccuracy:!0},fitBoundsOptions:{zoom:17}})]}))]})]})}window.Buffer=pe.Buffer;ue.render(t(ge.StrictMode,{children:t(ve,{})}),document.getElementById("root"));
