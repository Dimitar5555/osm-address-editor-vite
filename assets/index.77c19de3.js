var J=Object.defineProperty,K=Object.defineProperties;var W=Object.getOwnPropertyDescriptors;var j=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable;var R=(s,t,e)=>t in s?J(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,N=(s,t)=>{for(var e in t||(t={}))X.call(t,e)&&R(s,e,t[e]);if(j)for(var e of j(t))Z.call(t,e)&&R(s,e,t[e]);return s},z=(s,t)=>K(s,W(t));import{j as M,r,d as v,o as Y,p as Q,c as ee,m as te,M as oe,t as se,a as re,b as ne,F as D,f as ae,e as le,S as ie,L as ce,G as de,g as ue,R as pe,h as ge}from"./vendor.a6bf9e15.js";const fe=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const g of i.addedNodes)g.tagName==="LINK"&&g.rel==="modulepreload"&&n(g)}).observe(document,{childList:!0,subtree:!0});function e(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerpolicy&&(i.referrerPolicy=a.referrerpolicy),a.crossorigin==="use-credentials"?i.credentials="include":a.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(a){if(a.ep)return;a.ep=!0;const i=e(a);fetch(a.href,i)}};fe();const o=M.exports.jsx,u=M.exports.jsxs,I=M.exports.Fragment,_=()=>{const[s,t]=r.exports.useState(!1);r.exports.useEffect(()=>{t(v.exports.isLoggedIn())},[]);const e=r.exports.useCallback(()=>{(async()=>(await v.exports.login({mode:"popup",clientId:"q9sRK4UuNqv3_HLE8E7m2-wUAKS3XJSFWb9apehpAqE",scopes:["read_prefs","write_api","write_notes"],redirectUrl:window.location.href.replace(window.location.hash,"")}),t(v.exports.isLoggedIn()),window.location.reload()))()},[]),n=r.exports.useCallback(()=>{(async()=>(v.exports.logout(),t(!1)))()},[]);return o(I,{children:s?o("button",{style:{height:"44px"},className:"button py-1 px-1 border-transparent border-4 bg-gray-300 text-gray-900 hover:text-gray-500",onClick:n,children:"logout"}):o("button",{style:{height:"44px"},className:"button py-1 px-1 border-transparent border-4 bg-gray-300 text-gray-900 hover:text-gray-500",onClick:e,children:"login"})})},he=()=>{const[s,t]=r.exports.useState(!1),[e,n]=r.exports.useState(void 0);return r.exports.useEffect(()=>{t(v.exports.isLoggedIn())},[]),r.exports.useEffect(()=>{!s||(async()=>{const a=await v.exports.getUser("me");n(a)})()},[s]),o(I,{children:e?o("img",{style:{width:"44px",height:"44px"},src:e.img.href,alt:e.display_name,title:e.display_name}):o("img",{})})},me=()=>{const[s,t]=r.exports.useState(!1),[e,n]=r.exports.useState(void 0);return r.exports.useEffect(()=>{t(v.exports.isLoggedIn())},[]),r.exports.useEffect(()=>{!s||(async()=>{const a=await v.exports.getUser("me");n(a)})()},[s]),u("div",{style:{zIndex:100,position:"relative",top:0,left:0,height:"44px",display:"flex",flexDirection:"row",backgroundColor:"rgba(0, 255, 255, 0.9)"},children:[u("div",{children:[o("h1",{className:"text-4xl font-bold",style:{display:"inline",margin:"0px"},children:"OSM address editor"}),e?u("span",{style:{marginLeft:"10px"},children:["Hi ",e==null?void 0:e.display_name,", You have"," ",e==null?void 0:e.changesets.count," changesets."]}):o("span",{style:{marginLeft:"10px"},children:"Please logged in as OSM user."})]}),u("div",{style:{display:"flex",flex:1,justifyContent:"end"},children:[o("div",{children:o(he,{})}),o("div",{children:o(_,{})})]})]})},xe=()=>{const[s,t]=r.exports.useState(!1);return{fetchOverpass:r.exports.useCallback(async(n,a,i)=>{var d;let g=300;g=i<18?300:i<19?150:50,t(!0),console.log("overpass: loading...");let f="[out:json]";f+=`[timeout:25];
`,f+='way["building"]',f+=`(around:${g},${n},${a});
`,f+="out meta geom;",console.log(f);const m=await fetch(`https://lz4.overpass-api.de/api/interpreter?data=${encodeURIComponent(f)}`,{});if(m.status!==200)return{type:"FeatureCollection",features:[]};const y=await m.json();console.log("overpass json elements: ",y.elements.length);const b=Y(y);console.log("overpass osmtogeojson raw: ",b);for await(const p of b.features){if(!p.properties)continue;if(p.id=p.properties.id.split("/")[1],p.geometry.type==="Polygon"){const w=Q(p.geometry.coordinates);var k=ee(w);p.properties.center=k.geometry.coordinates}const x=p.properties.uid;if(x){let w=localStorage.getItem(x+"-icon");if(w===null){const S=await v.exports.getUser(x);((d=S.img)==null?void 0:d.href)?(w=S.img.href,localStorage.setItem(x+"-icon",S.img.href)):localStorage.setItem(x+"-icon","")}p.properties.userIconHref=w||""}}return console.log("overpass osmtogeojson converted: ",b),console.log("overpass: loaded."),t(!1),b},[]),loadingOverpass:s}},G=({feature:s})=>{var e;const t=JSON.parse((e=s.properties)==null?void 0:e.center);return u(I,{children:[u("span",{className:"longitude",children:["Longitude: ",Math.round(t[0]*1e4)/1e4]}),", ",u("span",{className:"latitude",children:["Latitude: ",Math.round(t[1]*1e4)/1e4," "]})]})},E={key:"addr:postcode",displayName:"\u90F5\u4FBF\u756A\u53F7",placeholder:"101-0021"},H=[{key:"addr:province",displayName:"\u90FD\u9053\u5E9C\u770C",placeholder:"\u6771\u4EAC\u90FD"},{key:"addr:city",displayName:"\u5E02\u533A\u753A\u6751",placeholder:"\u5343\u4EE3\u7530\u533A"},{key:"addr:quarter",displayName:"\u5730\u540D",placeholder:"\u5916\u795E\u7530"}],U=[{key:"addr:neighbourhood",displayName:"\u4E01\u76EE",placeholder:"1\u4E01\u76EE"},{key:"addr:block_number",displayName:"\u756A\u5730",placeholder:"17"},{key:"addr:housenumber",displayName:"\u53F7",placeholder:"6",prefix:"-"}],q=({feature:s})=>{var t;return u(I,{children:[o("span",{className:"addr:postcode",children:(t=s.properties)==null?void 0:t[E.key]})," ",H.map(e=>{var n;return o("span",{className:e.key,children:(n=s.properties)==null?void 0:n[e.key]},e.key)})," ",U.map(e=>{var n,a;return u("span",{className:e.key,children:[(n=e.prefix)!=null?n:e.prefix,(a=s.properties)==null?void 0:a[e.key]]},e.key)})]})},L=({feature:s,fieldName:t,label:e,placeholder:n})=>{var f;const[a,i]=r.exports.useState((f=s.properties)==null?void 0:f[t]);r.exports.useEffect(()=>{var m;i((m=s.properties)==null?void 0:m[t])},[s]);const g=r.exports.useCallback(m=>{i(m.currentTarget.value)},[]);return u("div",{className:"w-full md:w-1/6 py-1 px-2 mb-6 md:mb-0",children:[o("label",{className:"block tracking-wide text-gray-700 text-xs font-bold mb-2",htmlFor:t,children:e||t}),o("input",{className:"appearance-none block w-full leading-tight rounded py-2 px-1 border border-gray-300 bg-gray-100 text-black placeholder-gray-500 placeholder-opacity-50 focus:outline-none focus:bg-white focus:border-gray-500",id:t,name:t,type:"text",placeholder:n,value:a,onChange:g})]})},ye=({feature:s,onCancel:t})=>{var k;const e=JSON.parse((k=s.properties)==null?void 0:k.center),[n,a]=r.exports.useState(s),[i,g]=r.exports.useState(!1),[f,m]=r.exports.useState(!1);r.exports.useEffect(()=>{m(v.exports.isLoggedIn())},[]),r.exports.useEffect(()=>{console.log(n.properties)},[n]);const y=r.exports.useCallback(async()=>{console.info("openReverseGeocoder",[e[0],e[1]]);const d=await te.openReverseGeocoder([e[0],e[1]]);console.info("openReverseGeocoder",d),a(p=>{const x={properties:N({"addr:province":d.prefecture,"addr:city":d.city},p.properties)};return N(N({},p),x)})},[]),b=r.exports.useCallback(d=>{g(!0),d.preventDefault();const p=new FormData(d.currentTarget),x={};p.forEach((w,S)=>x[S]=w),console.info(JSON.stringify(x,null,2)),g(!1)},[]);return o("div",{children:n.properties&&u(I,{children:[u("div",{children:["OSM:"," ",o("a",{className:"underline text-blue-600 hover:text-blue-800 visited:text-purple-600",href:"https://www.openstreetmap.org/"+n.properties.id,target:"_blank",children:n.properties.id})," | ",o(G,{feature:n})," | ",u("span",{children:["Address:"," ",o("span",{className:"underline",children:o(q,{feature:n})})]})]}),u("form",{onSubmit:b,children:[u("div",{className:"flex flex-wrap",children:[o(L,{feature:n,fieldName:E.key,label:E.displayName,placeholder:E.placeholder}),H.map(d=>o(L,{feature:n,fieldName:d.key,label:d.displayName,placeholder:d.placeholder},d.key))]}),o("div",{className:"flex flex-wrap",children:U.map(d=>o(L,{feature:n,fieldName:d.key,label:d.displayName,placeholder:d.placeholder},d.key))}),o("div",{className:"flex flex-wrap",children:u("div",{className:"w-full py-2 px-2 mb-6 md:mb-0",children:[o("button",{type:"button",onClick:t,className:"button rounded mr-4 py-2 px-3  bg-gray-200 text-red-600 hover:text-red-800",children:"Cancel"}),o("button",{type:"button",onClick:y,className:"button rounded mr-4 py-2 px-3 bg-green-300 text-gray-800 hover:text-white",children:"Load address from coordinates"}),o("button",{disabled:!f||i,className:"button rounded mr-2 py-2 px-3 bg-blue-300 text-gray-800 disabled:bg-blue-100 disabled:text-gray-400 hover:text-white",children:"Submit to OpenStreetMap (work in progress...)"}),!f&&u(I,{children:[o("span",{className:"mr-2 underline text-red-600",children:"Require logged in before you submit data to OpenStreetMap"}),o(_,{})]})]})})]})]})})};function be(s,t){const[e,n]=r.exports.useState(s);return r.exports.useEffect(()=>{const a=setTimeout(()=>{n(s)},t);return()=>{clearTimeout(a)}},[s,t]),e}const ve={id:"buildings-layer-fill",type:"fill",source:"buildings-source",paint:{"fill-color":["case",["boolean",["feature-state","select"],!1],"green",["boolean",["has","addr:province"],!1],"blue","pink"],"fill-opacity":["case",["boolean",["feature-state","select"],!1],.8,["boolean",["feature-state","hover"],!1],.8,.4]},filter:["==","$type","Polygon"]};function we(){const s=r.exports.useRef(null),[t,e]=r.exports.useState(),n=be(t,1e3),a=r.exports.useRef(null),[i,g]=r.exports.useState({type:"FeatureCollection",features:[]}),[f,m]=r.exports.useState("auto"),[y,b]=r.exports.useState(),[k,d]=r.exports.useState([]),{fetchOverpass:p,loadingOverpass:x}=xe();r.exports.useEffect(()=>{setTimeout(()=>{var l;console.log(window.location.hash),!!window.location.hash.endsWith("/0/0")&&(console.log("geolocateControlRef trigger"),(l=a.current)==null||l.trigger())},500)},[]);const w=r.exports.useCallback(async l=>{const c=l.target.getCenter(),h=l.target.getZoom(),C=await p(c.lat,c.lng,h);g(C)},[]),S=r.exports.useCallback(l=>{e(l.viewState)},[]),T=r.exports.useCallback(l=>{e(l.viewState)},[]);r.exports.useEffect(()=>{(async()=>{if(!n)return;const l=n,c=await p(l.latitude,l.longitude,l.zoom);g(c)})()},[n]);const V=r.exports.useCallback(l=>{var O;m("pointer");const{features:c,point:{x:h,y:C}}=l,F=c&&c[0];F?((O=s.current)==null||O.setFeatureState({source:"buildings-source",id:F.id},{hover:!0}),b({feature:F,x:h,y:C})):b(void 0)},[]),B=r.exports.useCallback(l=>{var c;m("auto"),(c=s.current)==null||c.querySourceFeatures("buildings-source").map(h=>{var C;(C=s.current)==null||C.setFeatureState({source:"buildings-source",id:h.id},{hover:!1})}),b(void 0)},[]),P=r.exports.useCallback(l=>{var h;A();const c=l.features&&l.features[0];!c||((h=s.current)==null||h.setFeatureState({source:"buildings-source",id:c.id},{select:!0}),d([c]))},[]),A=r.exports.useCallback(()=>{var l;(l=s.current)==null||l.querySourceFeatures("buildings-source").map(c=>{var h;(h=s.current)==null||h.setFeatureState({source:"buildings-source",id:c.id},{select:!1})}),d([])},[]),$=r.exports.useMemo(()=>{let l=30;return t&&(console.log(t.zoom),l=t.zoom<18?15:30),i.features.map((c,h)=>c.properties?o(oe,{style:{cursor:"pointer"},longitude:c.properties.center[0],latitude:c.properties.center[1],anchor:"center",children:c.properties.userIconHref.length>0?o("img",{src:c.properties.userIconHref,style:{width:l+"px",height:l+"px"}}):o("span",{dangerouslySetInnerHTML:{__html:se(c.properties.user||"noname",l)}})},`marker-${h}`):null)},[i,t]);return u("div",{children:[o(me,{}),u("div",{style:{zIndex:1,position:"absolute",top:0,left:0,height:"100vh",width:"100vw",display:"flex",flexDirection:"column"},children:[k.length>0&&o("div",{style:{zIndex:200,position:"absolute",top:"44px",left:0,height:"250px",width:"100vw",backgroundColor:"rgba(255, 255, 255, 0.9)"},children:o("div",{style:{padding:"10px"},children:k.map(l=>o(ye,{feature:l,onCancel:A},l.id))})}),u(re,z(N({ref:s},t),{onMove:S,onMoveEnd:T,onLoad:w,interactiveLayerIds:["buildings-layer-fill"],onClick:P,onMouseEnter:V,onMouseLeave:B,dragRotate:!1,boxZoom:!1,hash:!0,cursor:f,mapLib:ne,style:{width:"100%",height:"100%"},mapStyle:"https://raw.githubusercontent.com/geoloniamaps/basic/gh-pages/style.json",children:[o("div",{className:"fa-2xl",style:{zIndex:100,display:"flex",position:"absolute",top:"50%",left:"50%",textAlign:"center",verticalAlign:"middle"},children:x?o(D,{size:"2x",spin:!0,icon:ae}):o(D,{size:"2x",icon:le})}),o(ie,{id:"buildings-source",type:"geojson",data:i,children:o(ce,N({},ve))}),$,y&&u("div",{className:"tooltip",style:{zIndex:10,background:"rgba(255, 255, 255, 0.7)",padding:"5px",width:"250px",position:"absolute",left:y.x+5,top:y.y+5},children:[o(G,{feature:y.feature}),o("br",{}),o(q,{feature:y.feature})]}),o(de,{ref:a,position:"top-left",style:{marginTop:"55px"},showUserLocation:!0,showAccuracyCircle:!1,trackUserLocation:!1,positionOptions:{enableHighAccuracy:!0},fitBoundsOptions:{zoom:17}})]}))]})]})}window.Buffer=ue.Buffer;pe.render(o(ge.StrictMode,{children:o(we,{})}),document.getElementById("root"));
